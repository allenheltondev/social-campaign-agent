AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Persona Management API - REST API for managing personas and writing examples

Globals:
  Function:
    Runtime: nodejs24.x
    CodeUri: functions
    Architectures:
      - arm64
    Timeout: 15
    MemorySize: 1024
    Environment:
      Variables:
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: !Sub "'*'"

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment name

  AuthorizerArn:
    Type: String
    Default: ""
    Description: Optional ARN of existing Lambda authorizer. If not provided, internal authorizer will be created.

Conditions:
  CreateInternalAuthorizer: !Equals [!Ref AuthorizerArn, ""]

Metadata:
  esbuild-properties: &esbuild-properties
    Format: esm
    Minify: false
    OutExtension:
      - .js=.mjs
    Target: es2020
    Sourcemap: false
    EntryPoints:
      - index.mjs
    Banner:
      - js=import { createRequire } from 'module'; const require = createRequire(import.meta.url);
    External:
      - "@aws-sdk/*"
    Loader: []

Resources:
  PersonaTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  AuthorizerFunction:
    Type: AWS::Serverless::Function
    Condition: CreateInternalAuthorizer
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - auth/authorizer.mjs
    Properties:
      Handler: auth/authorizer.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:GetUser
              Resource: "*"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          USER_POOL_ID: !Ref CognitoUserPool
          USER_POOL_CLIENT_ID: !Ref UserPoolClient

  CampaignApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      Auth:
        DefaultAuthorizer: Authorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
         Authorizer:
          FunctionPayloadType: REQUEST
          FunctionArn: !If [CreateInternalAuthorizer, !GetAtt AuthorizerFunction.Arn, !Ref AuthorizerArn ]
          Identity:
            Headers:
              - Authorization
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: ./openapi.yaml

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Delete
    Properties:
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: tenantId
          AttributeDataType: String
          Required: false
          Mutable: true
      UserPoolTags:
        Project: CampaignAgent

  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub campaign-agent-${Environment}
      UserPoolId: !Ref CognitoUserPool

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref CognitoUserPool
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_CUSTOM_AUTH
        - ALLOW_USER_AUTH
      AuthSessionValidity: 3
      EnableTokenRevocation: true
      PreventUserExistenceErrors: ENABLED
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      AccessTokenValidity: 24
      IdTokenValidity: 24
      RefreshTokenValidity: 30
      AllowedOAuthFlowsUserPoolClient: true
      CallbackURLs:
        - "http://localhost:5173"
      LogoutURLs:
        - "http://localhost:5173"
      SupportedIdentityProviders:
        - COGNITO

  CreatePersonaFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/create-persona.mjs
    Properties:
      Handler: persona/create-persona.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:PutItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        CreatePersona:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas
            Method: POST

  GetPersonaFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/get-persona.mjs
    Properties:
      Handler: persona/get-persona.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:GetItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        GetPersona:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}
            Method: GET

  UpdatePersonaFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/update-persona.mjs
    Properties:
      Handler: persona/update-persona.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        UpdatePersona:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}
            Method: PUT

  DeletePersonaFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/delete-persona.mjs
    Properties:
      Handler: persona/delete-persona.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        DeletePersona:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}
            Method: DELETE

  ListPersonasFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/list-personas.mjs
    Properties:
      Handler: persona/list-personas.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !Sub "${PersonaTable.Arn}/index/GSI1"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        ListPersonas:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas
            Method: GET

  CreateExampleFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/examples/create-example.mjs
    Properties:
      Handler: persona/examples/create-example.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource:
                - !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        CreateExample:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}/examples
            Method: POST

  ListExamplesFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/examples/list-examples.mjs
    Properties:
      Handler: persona/examples/list-examples.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !Sub "${PersonaTable.Arn}/index/GSI1"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        GetExamples:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}/examples
            Method: GET

  DeleteExampleFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/examples/delete-example.mjs
    Properties:
      Handler: persona/examples/delete-example.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        DeleteExample:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}/examples/{exampleId}
            Method: DELETE

  StartStyleAnalysisFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/start-style-analysis.mjs
    Properties:
      Handler: persona/start-style-analysis.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          EVENT_BUS_NAME: default
      Events:
        TriggerAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /personas/{personaId}/analyze
            Method: POST

  StyleInferenceFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - agents/persona-inference.mjs
    Properties:
      Handler: agents/persona-inference.handler
      Timeout: 60
      MemorySize: 2048
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource:
                - arn:aws:bedrock:*::foundation-model/amazon.nova-*
                - !Sub arn:${AWS::Partition}:bedrock:*:${AWS::AccountId}:inference-profile/us.amazon.nova-*
                - !Sub arn:${AWS::Partition}:bedrock:*:${AWS::AccountId}:inference-profile/global.anthropic.claude-sonnet-*
                - arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-*
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          EVENT_BUS_NAME: default
          MODEL_ID: us.amazon.nova-pro-v1:0
      Events:
        StyleAnalysisRequest:
          Type: EventBridgeRule
          Properties:
            EventBusName: default
            Pattern:
              source: ["persona-management-api"]
              detail-type: ["Style Analysis Requested"]

  StyleAnalysisCompleteFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - persona/events/style-analysis-complete.mjs
    Properties:
      Handler: persona/events/style-analysis-complete.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        StyleAnalysisCompletion:
          Type: EventBridgeRule
          Properties:
            EventBusName: default
            Pattern:
              source: ["persona-management-api"]
              detail-type: ["Style Analysis Completed"]

  BrandAssetsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub "campaign-agent-brand-assets-${Environment}-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7

  CreateBrandFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/create-brand.mjs
    Properties:
      Handler: brand/create-brand.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:PutItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        CreateBrand:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands
            Method: POST

  GetBrandFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/get-brand.mjs
    Properties:
      Handler: brand/get-brand.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:GetItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        GetBrand:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands/{brandId}
            Method: GET

  UpdateBrandFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/update-brand.mjs
    Properties:
      Handler: brand/update-brand.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        UpdateBrand:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands/{brandId}
            Method: PUT

  DeleteBrandFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/delete-brand.mjs
    Properties:
      Handler: brand/delete-brand.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        DeleteBrand:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands/{brandId}
            Method: DELETE

  ListBrandsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/list-brands.mjs
    Properties:
      Handler: brand/list-brands.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !Sub "${PersonaTable.Arn}/index/GSI1"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        ListBrands:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands
            Method: GET

  UploadAssetFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/assets/upload-asset.mjs
    Properties:
      Handler: brand/assets/upload-asset.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
              Resource: !Sub "${BrandAssetsBucket.Arn}/*"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          ASSETS_BUCKET: !Ref BrandAssetsBucket
      Events:
        UploadAsset:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands/{brandId}/assets
            Method: POST

  ListAssetsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/assets/list-assets.mjs
    Properties:
      Handler: brand/assets/list-assets.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !Sub "${PersonaTable.Arn}/index/GSI1"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        ListAssets:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands/{brandId}/assets
            Method: GET

  DeleteAssetFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - brand/assets/delete-asset.mjs
    Properties:
      Handler: brand/assets/delete-asset.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action:
                - s3:DeleteObject
              Resource: !Sub "${BrandAssetsBucket.Arn}/*"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          ASSETS_BUCKET: !Ref BrandAssetsBucket
      Events:
        DeleteAsset:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /brands/{brandId}/assets/{assetId}
            Method: DELETE

  CreateCampaignFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/create-campaign.mjs
    Properties:
      Handler: campaign/create-campaign.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: lambda:InvokeFunction
              Resource: !Sub '${BuildCampaignFunction.Arn}:*'
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          BUILD_CAMPAIGN_FUNCTION_NAME: !Ref BuildCampaignFunction
      Events:
        CreateCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns
            Method: POST

  BuildCampaignFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/build-campaign.mjs
    Properties:
      Handler: campaign/build-campaign.handler
      Timeout: 300
      DurableConfig:
        ExecutionTimeout: 604800 # 1 week
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:BatchWriteItem
                - dynamodb:BatchGetItem
                - dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !Sub "${PersonaTable.Arn}/index/GSI1"
                - !Sub "${PersonaTable.Arn}/index/GSI2"
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource:
                - arn:aws:bedrock:*::foundation-model/amazon.nova-*
                - !Sub arn:${AWS::Partition}:bedrock:*:${AWS::AccountId}:inference-profile/us.amazon.nova-*
                - !Sub arn:${AWS::Partition}:bedrock:*:${AWS::AccountId}:inference-profile/global.anthropic.claude-sonnet-*
                - arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-*
            - Effect: Allow
              Action:
                - lambda:SendDurableExecutionCallbackSuccess
                - lambda:SendDurableExecutionCallbackFailure
                - lambda:WaitForCallback
                - lambda:CreateDurableExecution
                - lambda:GetDurableExecution
              Resource: "*"
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          # MODEL_ID: us.amazon.nova-pro-v1:0

  ApprovalCallbackFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/approval-callback.mjs
    Properties:
      Handler: campaign/approval-callback.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:GetItem
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action: lambda:SendDurableExecutionCallbackSuccess
              Resource: "*"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        ApprovalApi:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns/{campaignId}/approve
            Method: POST

  GetCampaignFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/get-campaign.mjs
    Properties:
      Handler: campaign/get-campaign.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:GetItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        GetCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns/{campaignId}
            Method: GET

  ListCampaignPostsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/list-posts.mjs
    Properties:
      Handler: campaign/list-posts.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !Sub "${PersonaTable.Arn}/index/GSI1"
                - !Sub "${PersonaTable.Arn}/index/GSI2"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        ListPosts:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns/{campaignId}/posts
            Method: GET

  UpdateCampaignFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/update-campaign.mjs
    Properties:
      Handler: campaign/update-campaign.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          EVENT_BUS_NAME: default
      Events:
        UpdateCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns/{campaignId}
            Method: PUT

  DeleteCampaignFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/delete-campaign.mjs
    Properties:
      Handler: campaign/delete-campaign.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt PersonaTable.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        DeleteCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns/{campaignId}
            Method: DELETE

  ListCampaignsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/list-campaigns.mjs
    Properties:
      Handler: campaign/list-campaigns.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !Sub "${PersonaTable.Arn}/index/GSI1"
                - !Sub "${PersonaTable.Arn}/index/GSI2"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
      Events:
        ListCampaigns:
          Type: Api
          Properties:
            RestApiId: !Ref CampaignApi
            Path: /campaigns
            Method: GET

  UpdateCampaignStatusFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/update-status.mjs
    Properties:
      Handler: campaign/update-status.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          EVENT_BUS_NAME: default
      Events:
        StatusUpdateRequest:
          Type: EventBridgeRule
          Properties:
            EventBusName: default
            Pattern:
              source: ["campaign-api", "campaign-planner", "content-generator"]
              detail-type: ["Campaign Status Update Request"]

  WorkflowCompletionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        <<: *esbuild-properties
        EntryPoints:
          - campaign/events/workflow-completion.mjs
    Properties:
      Handler: campaign/events/workflow-completion.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource: !GetAtt PersonaTable.Arn
            - Effect: Allow
              Action: events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
      Environment:
        Variables:
          TABLE_NAME: !Ref PersonaTable
          EVENT_BUS_NAME: default
      Events:
        WorkflowCompletion:
          Type: EventBridgeRule
          Properties:
            EventBusName: default
            Pattern:
              source: ["campaign-planner", "content-generator"]
              detail-type: ["Campaign Planning Completed", "Campaign Planning Failed", "Content Generation Completed", "Content Generation Failed"]



Outputs:
  PersonaApiUrl:
    Description: API Gateway endpoint URL for Persona Management API
    Value: !Sub 'https://${CampaignApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient

  UserPoolDomain:
    Description: Cognito User Pool Domain
    Value: !Sub "https://${UserPoolDomain}.auth.${AWS::Region}.amazoncognito.com"
